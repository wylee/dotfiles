#!/bin/sh
# [WIP] Set macOS system preferences
#
# Inspired by (and largely copied from):
#
# - https://github.com/pawelgrzybek/dotfiles/blob/master/setup-macos.sh
# - https://github.com/mathiasbynens/dotfiles/blob/master/.macos
#
# Issues:
#
# - Figuring out how to set preferences is hard
# - Setting preferences via `defaults write` isn't always reflected in
#   the macOS GUI

# Disable boot sound effects
sudo nvram SystemAudioVolume=" "

# Expand save dialogs
defaults write -g NSNavPanelExpandedStateForSaveMode -bool true
defaults write -g NSNavPanelExpandedStateForSaveMode2 -bool true

# Disable the “Are you sure you want to open this application?” dialog
defaults write com.apple.LaunchServices LSQuarantine -bool false

# Close System Preferences GUI
osascript -e 'tell application "System Preferences" to quit'

# Finder > View > As List
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"

# System Preferences > Dock
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock magnification -bool false
defaults write com.apple.dock tilesize -int 48

defaults write com.apple.systemuiserver 'NSStatusItem Visible Siri' 0
defaults write com.apple.systemuiserver 'NSStatusItem Visible com.apple.menuextra.airport' 1
defaults write com.apple.systemuiserver 'NSStatusItem Visible com.apple.menuextra.bluetooth' 1
defaults write com.apple.systemuiserver 'NSStatusItem Visible com.apple.menuextra.clock' 1
defaults write com.apple.systemuiserver 'NSStatusItem Visible com.apple.menuextra.volume' 1
defaults write com.apple.systemuiserver menuExtras -array \
    '/System/Library/CoreServices/Menu Extras/AirPort.menu' \
    '/System/Library/CoreServices/Menu Extras/Clock.menu' \
    '/System/Library/CoreServices/Menu Extras/Bluetooth.menu' \
    '/System/Library/CoreServices/Menu Extras/Volume.menu'

# Keyboard
# echo "Mapping keys:"
# echo
# echo "    caps lock => left control"
# echo "    left control => caps lock"
# echo
# XXX: The 1452-591-0 is a keyboard-specific identifier. To make this
#      work generically, the identifier will have to be pulled from...
#      somewhere.
# defaults -currentHost write -g com.apple.keyboard.modifiermapping.1452-591-0 '(
#         {
#             "HIDKeyboardModifierMappingSrc" = 30064771129;
#             "HIDKeyboardModifierMappingDst" = 30064771300;
#         },
#         {
#             "HIDKeyboardModifierMappingSrc" = 30064771296;
#             "HIDKeyboardModifierMappingDst" = 30064771129;
#         },
#         {
#             "HIDKeyboardModifierMappingSrc" = 30064771300;
#             "HIDKeyboardModifierMappingDst" = 30064771129;
#         }
#     )'

defaults write -g ApplePressAndHoldEnabled -bool false

# Allow full keyboard navigation (e.g., Tab in dialogs)
defaults write -g AppleKeyboardUIMode -int 3

# Set fast keyboard repeat rate
defaults write -g KeyRepeat -int 5
defaults write -g InitialKeyRepeat -int 15

# System Preferences > Trackpad > Tap to click
# XXX: Are the global versions actually necessary?
defaults write com.apple.AppleMultitouchTrackpad Clicking -bool true
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true

# Terminal > Window
echo "Adding Terminal keyboard shortcuts:"
echo
echo "    command-left-arrow => show previous tab"
echo "    command-right-arrow => show next tab"
echo
defaults write com.apple.Terminal NSUserKeyEquivalents -dict-add 'Show Previous Tab' '@\UF702'
defaults write com.apple.Terminal NSUserKeyEquivalents -dict-add 'Show Next Tab' '@\UF703'

# Disable all autocorrection
defaults write -g NSAutomaticCapitalizationEnabled -bool false
defaults write -g NSAutomaticDashSubstitutionEnabled -bool false
defaults write -g NSAutomaticPeriodSubstitutionEnabled -bool false
defaults write -g NSAutomaticQuoteSubstitutionEnabled -bool false
defaults write -g NSAutomaticSpellingCorrectionEnabled -bool false
defaults write -g NSAutomaticTextCompletionEnabled -bool false
